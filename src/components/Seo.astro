---
export interface Props {
  title: string;
  description?: string;
  image?: string;
  canonical?: string;
  noindex?: boolean;
  type?: string;
  publishedTime?: string;
  modifiedTime?: string;
  author?: string;
  tags?: string[];
  readingTime?: number;
  wordCount?: number;
  category?: string;
}

const { 
  title, 
  description, 
  image, 
  canonical, 
  noindex = false,
  type = "website",
  publishedTime,
  modifiedTime,
  author,
  tags,
  readingTime,
  wordCount,
  category
} = Astro.props;

// Default meta description
const metaDescription = description || "A daily devotional and meditations on God's Word. Discover how God speaks through His Word, His Spirit, His people, wisdom, and circumstances.";
// Ensure image is always an absolute URL
let metaImage: string;
if (image) {
  // If image is already absolute, use it; otherwise make it absolute
  metaImage = image.startsWith('http://') || image.startsWith('https://') 
    ? image 
    : new URL(image, Astro.url.origin).href;
} else {
  // Default image - always make it absolute
  metaImage = new URL("/howgodspeakstous.png", Astro.url.origin).href;
}
const canonicalUrl = canonical || Astro.url.href;

// Generate enhanced structured data
const baseStructuredData = {
  "@context": "https://schema.org",
  "@type": type === "article" ? "Article" : "WebPage",
  "headline": title,
  "description": metaDescription,
  "image": metaImage,
  "url": canonicalUrl,
  "inLanguage": "en-US",
  "isAccessibleForFree": true,
};

const articleStructuredData = type === "article" ? {
  ...baseStructuredData,
  "@type": "Article",
  "author": author ? {
    "@type": "Person",
    "name": author
  } : undefined,
  "publisher": {
    "@type": "Organization",
    "name": "How God Speaks To Us",
    "logo": {
      "@type": "ImageObject",
      "url": `${Astro.url.origin}/favicon.png`
    }
  },
  "datePublished": publishedTime,
  "dateModified": modifiedTime || publishedTime,
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": canonicalUrl
  },
  "keywords": tags?.join(", "),
  "articleSection": category,
  "wordCount": wordCount,
  "timeRequired": readingTime ? `PT${readingTime}M` : undefined,
  "genre": "Religion & Spirituality",
  "about": tags?.map(tag => ({
    "@type": "Thing",
    "name": tag
  }))
} : baseStructuredData;

const websiteStructuredData = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "How God Speaks To Us",
  "description": "A daily devotional and meditations on God's Word. Discover how God speaks through His Word, His Spirit, His people, wisdom, and circumstances.",
  "url": Astro.url.origin,
  "publisher": {
    "@type": "Organization",
    "name": "How God Speaks To Us",
    "logo": {
      "@type": "ImageObject",
      "url": `${Astro.url.origin}/favicon.png`
    }
  },
  "potentialAction": {
    "@type": "SearchAction",
    "target": `${Astro.url.origin}/blog?tag={search_term_string}`,
    "query-input": "required name=search_term_string"
  }
};
---

<!-- Enhanced Meta Tags -->
<meta name="generator" content="Astro" />
<meta name="theme-color" content="#000000" />
<meta name="msapplication-TileColor" content="#000000" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="How God Speaks To Us" />

<!-- Meta Description - Always present -->
<meta name="description" content={metaDescription} />

<!-- Canonical URL -->
<link rel="canonical" href={canonicalUrl} />

<!-- Robots meta -->
{noindex ? (
  <meta name="robots" content="noindex, nofollow" />
) : (
  <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
)}

<!-- Article-specific meta tags -->
{type === "article" && (
  <>
    <meta name="article:author" content={author} />
    <meta name="article:published_time" content={publishedTime} />
    <meta name="article:modified_time" content={modifiedTime || publishedTime} />
    {tags && tags.map(tag => (
      <meta name="article:tag" content={tag} />
    ))}
    {category && <meta name="article:section" content={category} />}
    {readingTime && <meta name="twitter:label1" content="Reading time" />}
    {readingTime && <meta name="twitter:data1" content={`${readingTime} min read`} />}
  </>
)}

<!-- Open Graph / Facebook -->
<meta property="og:type" content={type} />
<meta property="og:url" content={canonicalUrl} />
<meta property="og:title" content={title} />
<meta property="og:description" content={metaDescription} />
<meta property="og:image" content={metaImage} />
<meta property="og:image:secure_url" content={metaImage} />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:image:alt" content={title} />
<meta property="og:image:type" content="image/png" />
<meta property="og:site_name" content="How God Speaks To Us" />
<meta property="og:locale" content="en_US" />
<meta property="og:locale:alternate" content="en_US" />

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:url" content={canonicalUrl} />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={metaDescription} />
<meta name="twitter:image" content={metaImage} />
<meta name="twitter:image:alt" content={title} />
<meta name="twitter:site" content="@djmartin2019" />
{author && <meta name="twitter:creator" content={`@${author.toLowerCase().replace(/\s+/g, '')}`} />}

<!-- Organization Structured Data -->
<script type="application/ld+json" set:html={JSON.stringify({
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "How God Speaks To Us",
  "url": Astro.url.origin,
  "logo": `${Astro.url.origin}/favicon.png`,
  "description": "A daily devotional and meditations on God's Word. Discover how God speaks through His Word, His Spirit, His people, wisdom, and circumstances.",
  "sameAs": [
    "https://github.com/djmartin2019"
  ]
})} />

<!-- Structured Data -->
<script type="application/ld+json" set:html={JSON.stringify(articleStructuredData)} />
{type !== "article" && <script type="application/ld+json" set:html={JSON.stringify(websiteStructuredData)} />}
